name: security-scan-scheduled
on:
  # allow for version to be manually specified under actions page
  workflow_dispatch: {}
  schedule:
    # Monday 9am EST
    - cron: "0 13 * * 1"
jobs:
  scan-images:
    name: Trivy Scan
    runs-on: "ubuntu-18.04"
    env:
      SCAN_DIR: _output/scans
      IMAGE_REPO: quay.io/solo-io
    steps:
      - name: Cancel Previous Actions
        uses: styfle/cancel-workflow-action@0.4.1
        with:
          access_token: ${{ github.token }}
      - name: Free disk space
        run: |
          echo "Before clearing disk space:"
          df -h

          # https://github.com/actions/virtual-environments/issues/709
          sudo apt-get clean

          # Clean up pre-installed tools
          # https://github.com/actions/virtual-environments/issues/1918
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf $AGENT_TOOLSDIRECTORY

          echo "After clearing disk space:"
          df -h
      - name: Install Trivy and Codeql
        run: |
          wget https://github.com/aquasecurity/trivy/releases/download/v0.18.3/trivy_0.18.3_Linux-64bit.deb
          sudo dpkg -i trivy_0.18.3_Linux-64bit.deb
          wget -O tmp.zip https://github.com/github/codeql-cli-binaries/releases/download/v2.5.7/codeql-linux64.zip
          tar -xf tmp.zip
          echo $PATH
          sudo mv codeql/codeql /usr/local/bin/codeql
      - name: Set up Go 1.16.3
        uses: actions/setup-go@v2
        with:
          go-version: 1.16.3
        id: go
      - name: Check out code into the Go module directory
        uses: actions/checkout@v2
      - name: Setup - gcloud / gsutil
        uses: google-github-actions/setup-gcloud@master
        with:
          service_account_key: ${{ secrets.GLOO_VULN_REPORTER }}
          project_id: solo-public
          export_default_credentials: true
      - name: Run Scan and Publish Docs
        env:
          SCAN_DIR: ${{ env.SCAN_DIR }}
          IMAGE_REPO: quay.io/solo-io
          MIN_SCANNED_VERSION: 'v1.6.0'
          GITHUB_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
        run: |
          mkdir -p ${{ env.SCAN_DIR }}
          make run-security-scan
          make publish-security-scan
      # upload both open source and enterprise scan results to GH security tab
      - name: Upload Open source Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v1
        with:
          sarif_file: _output/scans
